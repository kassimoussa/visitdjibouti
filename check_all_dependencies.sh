#!/bin/bash

#############################################################
# Analyse COMPL√àTE de toutes les d√©pendances entre migrations
#############################################################

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë     Analyse Exhaustive des D√©pendances - Migrations         ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

cd database/migrations 2>/dev/null || cd /var/www/html/visitdjibouti/database/migrations

#############################################################
# Fonction pour v√©rifier qu'une table A vient avant table B
#############################################################
check_order() {
    local table_created=$1
    local table_referenced=$2
    local migration_file=$3

    CREATE_LINE=$(ls -1 *.php | grep -n "create.*${table_created}" | head -1 | cut -d: -f1)
    REF_LINE=$(echo "$migration_file" | cut -d: -f1)

    if [ -z "$CREATE_LINE" ]; then
        echo "   ‚ö†Ô∏è  Table '$table_created' non trouv√©e"
        return 1
    fi

    if [ "$CREATE_LINE" -lt "$REF_LINE" ]; then
        echo "   ‚úÖ OK: $table_created (ligne $CREATE_LINE) avant $table_referenced (ligne $REF_LINE)"
        return 0
    else
        echo "   ‚ùå ERREUR: $table_referenced (ligne $REF_LINE) r√©f√©rence $table_created (ligne $CREATE_LINE) AVANT sa cr√©ation !"
        return 1
    fi
}

#############################################################
# 1. V√âRIFIER TOUTES LES FOREIGN KEYS
#############################################################
echo "üîç √âTAPE 1: Analyse de toutes les foreign keys"
echo ""

ERRORS=0
WARNINGS=0
SUCCESS=0

# Extraire toutes les contraintes foreign key
echo "üìã Foreign keys d√©tect√©es:"
echo ""

grep -n "constrained\|->references\|->foreign" *.php | while IFS=: read -r file line content; do

    # Extraire le nom de la table r√©f√©renc√©e
    if [[ $content =~ constrained\([\'\"]+([a-z_]+) ]]; then
        REFERENCED_TABLE="${BASH_REMATCH[1]}"
    elif [[ $content =~ references.*on\([\'\"]+([a-z_]+) ]]; then
        REFERENCED_TABLE="${BASH_REMATCH[1]}"
    else
        continue
    fi

    # Ignorer certains cas
    [[ "$REFERENCED_TABLE" == "id" ]] && continue

    echo "   üìå $file (ligne $line)"
    echo "      ‚îî‚îÄ> R√©f√©rence: $REFERENCED_TABLE"

done | head -50

echo ""

#############################################################
# 2. V√âRIFICATIONS SP√âCIFIQUES PAR TABLE
#############################################################
echo "üîç √âTAPE 2: V√©rifications sp√©cifiques"
echo ""

echo "1Ô∏è‚É£  ADMIN_USERS (cr√©√©e mars 2025)"
echo "   R√©f√©renc√©e par:"

# POIs
POIS_LINE=$(ls -1 *.php | grep -n "create_pois_table" | cut -d: -f1)
ADMIN_LINE=$(ls -1 *.php | grep -n "create_admin_users_table" | cut -d: -f1)

if [ "$ADMIN_LINE" -lt "$POIS_LINE" ]; then
    echo "   ‚úÖ pois.creator_id ‚Üí admin_users (ligne $POIS_LINE > $ADMIN_LINE)"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: pois avant admin_users !"
    ((ERRORS++))
fi

echo ""

echo "2Ô∏è‚É£  MEDIA (cr√©√©e mai 2025)"
echo "   R√©f√©renc√©e par:"

MEDIA_LINE=$(ls -1 *.php | grep -n "create_media_table" | cut -d: -f1)

# POIs featured_image
if [ "$MEDIA_LINE" -lt "$POIS_LINE" ]; then
    echo "   ‚úÖ pois.featured_image_id ‚Üí media"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: pois avant media !"
    ((ERRORS++))
fi

# Tours featured_image
TOURS_LINE=$(ls -1 *.php | grep -n "2025_09_01_100000_create_tours" | cut -d: -f1)
if [ "$MEDIA_LINE" -lt "$TOURS_LINE" ]; then
    echo "   ‚úÖ tours.featured_image_id ‚Üí media"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: tours avant media !"
    ((ERRORS++))
fi

# Organization logo
ORG_LINE=$(ls -1 *.php | grep -n "create_organization_info_table" | cut -d: -f1)
if [ "$MEDIA_LINE" -lt "$ORG_LINE" ]; then
    echo "   ‚úÖ organization_info.logo_id ‚Üí media"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: organization avant media !"
    ((ERRORS++))
fi

echo ""

echo "3Ô∏è‚É£  CATEGORIES (cr√©√©e mai 2025)"
echo "   R√©f√©renc√©e par:"

CAT_LINE=$(ls -1 *.php | grep -n "create_categories_table" | cut -d: -f1)

# POI categories pivot
POI_CAT_LINE=$(echo "$POIS_LINE")  # M√™me fichier
if [ "$CAT_LINE" -lt "$POI_CAT_LINE" ]; then
    echo "   ‚úÖ category_poi pivot ‚Üí categories"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: pivot avant categories !"
    ((ERRORS++))
fi

# Categories hierarchy (self-reference)
CAT_HIER_LINE=$(ls -1 *.php | grep -n "add_hierarchy_to_categories" | cut -d: -f1)
if [ "$CAT_LINE" -lt "$CAT_HIER_LINE" ]; then
    echo "   ‚úÖ categories.parent_id ‚Üí categories (self-reference)"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: hierarchy avant cr√©ation !"
    ((ERRORS++))
fi

echo ""

echo "4Ô∏è‚É£  POIS (cr√©√©e mai 2025)"
echo "   R√©f√©renc√©e par:"

# poi_translations
POI_TRANS_LINE=$(echo "$POIS_LINE")  # M√™me fichier
echo "   ‚úÖ poi_translations ‚Üí pois (m√™me fichier)"
((SUCCESS++))

# poi_tour_operator pivot
POI_TO_LINE=$(ls -1 *.php | grep -n "create_poi_tour_operator_table" | cut -d: -f1)
if [ "$POIS_LINE" -lt "$POI_TO_LINE" ]; then
    echo "   ‚úÖ poi_tour_operator.poi_id ‚Üí pois (ligne $POI_TO_LINE > $POIS_LINE)"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: pivot avant pois !"
    ((ERRORS++))
fi

echo ""

echo "5Ô∏è‚É£  EVENTS (cr√©√©e mai 2025)"
echo "   R√©f√©renc√©e par:"

EVENT_LINE=$(ls -1 *.php | grep -n "create_events_tables" | cut -d: -f1)

# Event translations, registrations, etc. (m√™me fichier)
echo "   ‚úÖ event_translations, event_registrations, etc. ‚Üí events (m√™me fichier)"
((SUCCESS++))

# Add tour_operator to events
EVENT_TO_LINE=$(ls -1 *.php | grep -n "add_tour_operator_to_events" | cut -d: -f1)
if [ "$EVENT_LINE" -lt "$EVENT_TO_LINE" ]; then
    echo "   ‚úÖ events.tour_operator_id ‚Üí ajout√© apr√®s cr√©ation"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: modification avant cr√©ation !"
    ((ERRORS++))
fi

echo ""

echo "6Ô∏è‚É£  APP_USERS (cr√©√©e ao√ªt 2025)"
echo "   R√©f√©renc√©e par:"

APP_USERS_LINE=$(ls -1 *.php | grep -n "create_app_users_table" | cut -d: -f1)

# User favorites
FAV_LINE=$(ls -1 *.php | grep -n "create_user_favorites_table" | cut -d: -f1)
if [ "$APP_USERS_LINE" -lt "$FAV_LINE" ]; then
    echo "   ‚úÖ user_favorites.app_user_id ‚Üí app_users"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: favorites avant app_users !"
    ((ERRORS++))
fi

# Reservations
RESERV_LINE=$(ls -1 *.php | grep -n "create_reservations_table" | cut -d: -f1)
if [ "$APP_USERS_LINE" -lt "$RESERV_LINE" ]; then
    echo "   ‚úÖ reservations.app_user_id ‚Üí app_users"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: reservations avant app_users !"
    ((ERRORS++))
fi

# Location history
LOC_LINE=$(ls -1 *.php | grep -n "create_user_location_history_table" | cut -d: -f1)
if [ "$APP_USERS_LINE" -lt "$LOC_LINE" ]; then
    echo "   ‚úÖ user_location_history.app_user_id ‚Üí app_users"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: location_history avant app_users !"
    ((ERRORS++))
fi

echo ""

echo "7Ô∏è‚É£  TOUR_OPERATORS (cr√©√©e ao√ªt 2025)"
echo "   R√©f√©renc√©e par:"

TO_LINE=$(ls -1 *.php | grep -n "create_simple_tour_operators_tables" | cut -d: -f1)

# Tours
if [ "$TO_LINE" -lt "$TOURS_LINE" ]; then
    echo "   ‚úÖ tours.tour_operator_id ‚Üí tour_operators (ligne $TOURS_LINE > $TO_LINE)"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: tours avant tour_operators !"
    ((ERRORS++))
fi

# poi_tour_operator pivot
if [ "$TO_LINE" -lt "$POI_TO_LINE" ]; then
    echo "   ‚úÖ poi_tour_operator.tour_operator_id ‚Üí tour_operators"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: pivot avant tour_operators !"
    ((ERRORS++))
fi

# tour_operator_users
TOU_LINE=$(ls -1 *.php | grep -n "create_tour_operator_users_table" | cut -d: -f1)
if [ "$TO_LINE" -lt "$TOU_LINE" ]; then
    echo "   ‚úÖ tour_operator_users.tour_operator_id ‚Üí tour_operators"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: tour_operator_users avant tour_operators !"
    ((ERRORS++))
fi

# events.tour_operator_id
if [ "$TO_LINE" -lt "$EVENT_TO_LINE" ]; then
    echo "   ‚úÖ events.tour_operator_id ‚Üí tour_operators"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: events modification avant tour_operators !"
    ((ERRORS++))
fi

echo ""

echo "8Ô∏è‚É£  TOURS (cr√©√©e septembre 2025)"
echo "   R√©f√©renc√©e par:"

# tour_translations
TOUR_TRANS_LINE=$(ls -1 *.php | grep -n "create_tour_translations_table" | cut -d: -f1)
if [ "$TOURS_LINE" -lt "$TOUR_TRANS_LINE" ]; then
    echo "   ‚úÖ tour_translations.tour_id ‚Üí tours"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: tour_translations avant tours !"
    ((ERRORS++))
fi

# tour_schedules
TOUR_SCHED_LINE=$(ls -1 *.php | grep -n "create_tour_schedules_table" | cut -d: -f1)
if [ "$TOURS_LINE" -lt "$TOUR_SCHED_LINE" ]; then
    echo "   ‚úÖ tour_schedules.tour_id ‚Üí tours"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: tour_schedules avant tours !"
    ((ERRORS++))
fi

# media_tour pivot
MEDIA_TOUR_LINE=$(ls -1 *.php | grep -n "create_media_tour_table" | cut -d: -f1)
if [ "$TOURS_LINE" -lt "$MEDIA_TOUR_LINE" ]; then
    echo "   ‚úÖ media_tour.tour_id ‚Üí tours"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: media_tour avant tours !"
    ((ERRORS++))
fi

echo ""

#############################################################
# 3. V√âRIFIER LES RELATIONS POLYMORPHIQUES
#############################################################
echo "üîç √âTAPE 3: Relations polymorphiques (morphTo)"
echo ""

echo "1Ô∏è‚É£  user_favorites (favoritable_type/id)"
echo "   Peut r√©f√©rencer: pois, events"
if [ "$POIS_LINE" -lt "$FAV_LINE" ] && [ "$EVENT_LINE" -lt "$FAV_LINE" ]; then
    echo "   ‚úÖ pois et events cr√©√©es avant favorites"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: favorites avant une des tables polymorphiques !"
    ((ERRORS++))
fi

echo ""

echo "2Ô∏è‚É£  reservations (reservable_type/id)"
echo "   Peut r√©f√©rencer: events (principalement)"
if [ "$EVENT_LINE" -lt "$RESERV_LINE" ]; then
    echo "   ‚úÖ events cr√©√©e avant reservations"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: reservations avant events !"
    ((ERRORS++))
fi

echo ""

echo "3Ô∏è‚É£  tours (target_type/id)"
echo "   Peut r√©f√©rencer: pois, events"
if [ "$POIS_LINE" -lt "$TOURS_LINE" ] && [ "$EVENT_LINE" -lt "$TOURS_LINE" ]; then
    echo "   ‚úÖ pois et events cr√©√©es avant tours"
    ((SUCCESS++))
else
    echo "   ‚ùå ERREUR: tours avant une des tables target !"
    ((ERRORS++))
fi

echo ""

#############################################################
# R√âSUM√â FINAL
#############################################################
echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë                    R√âSUM√â DE L'ANALYSE                       ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""
echo "‚úÖ V√©rifications r√©ussies: $SUCCESS"
echo "‚ùå Erreurs d√©tect√©es: $ERRORS"
echo "‚ö†Ô∏è  Avertissements: $WARNINGS"
echo ""

TOTAL=$((SUCCESS + ERRORS))
PERCENT=$((SUCCESS * 100 / TOTAL))

echo "üìä Taux de r√©ussite: $PERCENT% ($SUCCESS/$TOTAL)"
echo ""

if [ "$ERRORS" -eq 0 ]; then
    echo "üéâ PARFAIT ! Toutes les d√©pendances sont correctes !"
    echo ""
    echo "‚úÖ Vous pouvez ex√©cuter en toute s√©curit√©:"
    echo "   php artisan migrate:fresh --force"
    exit 0
else
    echo "‚ö†Ô∏è  ATTENTION ! $ERRORS erreur(s) d√©tect√©e(s)"
    echo ""
    echo "üîß Actions requises:"
    echo "   1. Corriger les migrations signal√©es ci-dessus"
    echo "   2. Relancer ce script pour v√©rifier"
    echo "   3. Puis ex√©cuter: php artisan migrate:fresh --force"
    exit 1
fi
